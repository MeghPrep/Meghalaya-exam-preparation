<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Admin — Single File</title>
<style>
:root{
  --bg:#071017;
  --card:rgba(255,255,255,0.03);
  --muted:#9fb4c2;
  --accent:#5ee4ff;
  --accent-2:#8a5cff;
  --danger:#ff5c6c;
  --glass-border: rgba(255,255,255,0.06);
  --radius:12px;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:
 radial-gradient(800px 300px at 10% 10%, rgba(94,228,255,0.03), transparent 5%),
 linear-gradient(180deg,#04060a,#071017);color:#e9f7fb}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 10px 30px rgba(138,92,255,0.08)}
h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
/* layout */
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.left{display:flex;flex-direction:column;gap:14px}
.card{background:var(--card);padding:14px;border-radius:var(--radius);border:1px solid var(--glass-border);backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small{padding:8px 10px;font-size:14px}
.row{display:flex;gap:8px;align-items:center}
.input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.25);color:inherit;outline:none}
.input:focus,textarea:focus,select:focus{box-shadow:0 0 10px rgba(90,200,255,0.06);border-color:var(--accent)}
button.btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#021018;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;box-shadow:0 8px 20px rgba(58,45,120,0.08)}
button.ghost{background:transparent;border:1px solid var(--glass-border);color:var(--muted)}
button.danger{background:var(--danger);color:white}
.btn:active::after{content:"";position:absolute;border-radius:50%;transform:scale(0);opacity:.4}
.controls .small{background:transparent;border:1px solid var(--glass-border);color:var(--muted);cursor:pointer;border-radius:8px}

/* accordion */
.accordion{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
.accordion:hover{transform:translateX(6px);transition:transform .18s}
.accordion .meta{font-size:13px;color:var(--muted)}
.accordion .chev{transition:transform .22s}

/* nested lists */
.list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.node{padding:10px;border-radius:8px;background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:space-between;gap:10px}
.node .leftcol{display:flex;gap:10px;align-items:center}
.icon{width:42px;height:42px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#021018;font-weight:700}
.node small{color:var(--muted)}
.node .actions{display:flex;gap:6px}

/* question editor area */
.editor{display:flex;flex-direction:column;gap:8px}
.editor .opts{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.editor input, .editor textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.25);color:inherit}

/* question list */
.qlist{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.qcard{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.qcard .meta{font-size:13px;color:var(--muted);margin-bottom:6px}

/* json output */
.json-output{width:100%;height:260px;background:#02131a;color:#8ef8ff;font-family:monospace;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:auto}

/* pdf preview */
.preview-frame{width:100%;height:320px;border:none;border-radius:8px;background:#000}

/* responsive */
@media(max-width:980px){.grid{grid-template-columns:1fr;}.left{order:2}}
/* ripple */
.ripple{position:absolute;border-radius:50%;transform:scale(0);opacity:.3;background:white;animation:r .6s linear}
@keyframes r{to{transform:scale(20);opacity:0}}

/* tiny helpers */
.hint{color:var(--muted);font-size:13px}
.small-muted{color:var(--muted);font-size:13px}
.flex{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>EduQuest Admin — Single File</h1>
        <div class="small-muted">Create categories, papers, years and questions. Copy JSON or persist locally.</div>
      </div>
    </div>

    <div class="controls">
      <button class="small" id="btnCopyJSON">Copy JSON</button>
      <button class="small ghost" id="btnSaveLocal">Save local</button>
      <button class="small ghost" id="btnLoadLocal">Load local</button>
      <button class="small ghost" id="btnResetLocal">Reset</button>
    </div>
  </div>

  <div class="grid">
    <div class="left">
      <div class="card">
        <h3>Create Category</h3>
        <div class="row" style="gap:10px;margin-top:8px">
          <input id="inpCatName" class="input" placeholder="Category name (e.g., General Knowledge)">
          <input id="inpCatSlug" class="input" placeholder="Slug (optional)">
        </div>
        <div style="margin-top:8px" class="row">
          <button class="btn" id="btnAddCat">Add Category</button>
        </div>
        <div class="hint" style="margin-top:8px">Categories are top-level grouping for papers and topics.</div>
      </div>

      <div class="card">
        <h3>Create Subcategory</h3>
        <select id="selCatForSub" class="input"></select>
        <input id="inpSubName" class="input" placeholder="Subcategory name (e.g., Indian History)">
        <div style="margin-top:8px"><button class="btn" id="btnAddSub">Add Subcategory</button></div>
      </div>

      <div class="card">
        <h3>Create Paper</h3>
        <select id="selSubForPaper" class="input"></select>
        <input id="inpPaperName" class="input" placeholder="Paper title (e.g., Exam 2020)">
        <div style="margin-top:8px"><button class="btn" id="btnAddPaper">Add Paper</button></div>
      </div>

      <div class="card">
        <h3>Create Year / Entry</h3>
        <select id="selPaperForYear" class="input"></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="inpYearLabel" class="input" placeholder="Label (e.g., 2019 or Jan 2020)">
          <input id="inpDriveLink" class="input" placeholder="Drive PDF share link (optional)">
        </div>
        <div style="margin-top:8px"><button class="btn" id="btnAddYear">Add Year</button></div>
      </div>

      <div class="card">
        <h3>Quick Search</h3>
        <input id="inpSearch" class="input" placeholder="Search category / sub / paper / year">
        <div class="hint">Type and press Enter to filter left tree</div>
      </div>
    </div>

    <main>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Catalog</h3>
          <div class="small-muted">Expand items to edit names and view years / questions</div>
        </div>

        <div id="catalogList" class="list" style="margin-top:12px;"></div>
      </section>

      <section class="card" style="margin-top:12px">
        <h3>Question Editor</h3>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="selCatQ" class="input" style="width:160px"></select>
          <select id="selSubQ" class="input" style="width:180px"></select>
          <select id="selPaperQ" class="input" style="width:180px"></select>
          <select id="selYearQ" class="input" style="width:150px"></select>
        </div>

        <div class="editor" style="margin-top:12px">
          <div style="display:flex;gap:8px">
            <input id="qNumber" class="input" placeholder="Q no" style="width:110px" />
            <input id="qText" class="input" placeholder="Question text" />
          </div>

          <div class="opts">
            <input id="optA" placeholder="Option A" />
            <input id="optB" placeholder="Option B" />
            <input id="optC" placeholder="Option C" />
            <input id="optD" placeholder="Option D" />
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <select id="qAnswer" class="input" style="width:140px">
              <option value="">Correct</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>
            <input id="qYoutube" class="input" placeholder="YouTube link (optional)" />
            <input id="qDriveQ" class="input" placeholder="Drive PDF link for this question (optional)" />
            <button class="btn" id="btnAddQ">Add Question</button>
            <button class="ghost" id="btnClearQ">Clear</button>
          </div>

          <label class="hint">Passage (optional)</label>
          <textarea id="qPassage" placeholder="Passage text (shown above a group of questions)"></textarea>

          <label class="hint">Solution / Explanation</label>
          <textarea id="qSolution" placeholder="Solution or explanation"></textarea>
        </div>

        <div style="margin-top:12px">
          <h4>Questions in selected year</h4>
          <div id="questionList" class="qlist"></div>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <h3>Preview / PDF</h3>
        <div id="pdfWrap" style="display:none">
          <div style="color:var(--muted);margin-bottom:8px">PDF Preview (Drive link must be shareable view link)</div>
          <iframe id="pdfPreview" class="preview-frame"></iframe>
        </div>
        <div style="margin-top:12px">
          <h4>Live JSON</h4>
          <pre id="jsonOut" class="json-output"></pre>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
/* =========================
   State and persistence
   ========================= */
const STORAGE_KEY = 'eduquest_admin_data_v1';

let state = load();
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { categories: [] };
    return JSON.parse(raw);
  }catch(e){
    return { categories: [] };
  }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderAll();
}
function resetState(){
  if(confirm('Reset all local data? This cannot be undone.')) {
    state = { categories: [] };
    save();
  }
}
function uid(pref='id'){ return pref+'_'+Date.now()+'_'+Math.floor(Math.random()*9999) }

/* =========================
   DOM helpers
   ========================= */
const qs = id => document.getElementById(id);
function makeRipple(el, e){
  const r = document.createElement('span');
  r.className='ripple';
  const rect = el.getBoundingClientRect();
  r.style.left = ( (e?.clientX||rect.left+rect.width/2) - rect.left ) + 'px';
  r.style.top = ( (e?.clientY||rect.top+rect.height/2) - rect.top ) + 'px';
  el.appendChild(r);
  setTimeout(()=>r.remove(),600);
}

/* =========================
   UI: populate selects and lists
   ========================= */
function renderAll(filtered=null){
  // filtered is optional - if provided, show only matching categories/papers
  const cats = filtered || state.categories;
  renderCatalog(cats);
  populateSelects();
  refreshQuestionList();
  renderJSON();
  updatePDFPreview();
}

function renderCatalog(cats){
  const out = qs('catalogList');
  out.innerHTML='';
  if(!cats || cats.length===0){
    out.innerHTML = '<div class="hint">No categories. Create one on the left.</div>';
    return;
  }
  cats.forEach(cat=>{
    const node = document.createElement('div');
    node.className='node';
    const left = document.createElement('div'); left.className='leftcol';
    const ico = document.createElement('div'); ico.className='icon'; ico.textContent = cat.name[0]||'C';
    const txt = document.createElement('div'); txt.innerHTML = `<strong>${cat.name}</strong><div class="hint">${cat.slug||''}</div>`;
    left.appendChild(ico); left.appendChild(txt);

    const actions = document.createElement('div'); actions.className='actions';
    const btnToggle = document.createElement('button'); btnToggle.className='ghost small'; btnToggle.textContent='Open';
    btnToggle.onclick = (e)=>{ makeRipple(btnToggle, e); toggleCategory(cat.id); };
    const btnEdit = document.createElement('button'); btnEdit.className='ghost small'; btnEdit.textContent='Edit';
    btnEdit.onclick = (e)=>{ makeRipple(btnEdit, e); editCategoryInline(cat.id); };
    const btnDel = document.createElement('button'); btnDel.className='danger small'; btnDel.textContent='Delete';
    btnDel.onclick = (e)=>{ makeRipple(btnDel, e); if(confirm('Delete category and everything inside?')){ deleteCategory(cat.id) } };

    actions.appendChild(btnToggle); actions.appendChild(btnEdit); actions.appendChild(btnDel);

    node.appendChild(left); node.appendChild(actions);
    out.appendChild(node);

    // children panel
    const panel = document.createElement('div'); panel.className='card';
    panel.style.marginTop='8px';
    panel.style.display = cat._open ? '' : 'none'; // internal open flag
    panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">${cat.name} — Subcategories</div>
      <div class="small-muted">Total subs: ${cat.subcategories.length}</div>
    </div>`;
    // list subs
    const subsWrap = document.createElement('div'); subsWrap.className='list'; subsWrap.style.marginTop='12px';
    cat.subcategories.forEach(sub=>{
      const sNode = document.createElement('div'); sNode.className='node';
      sNode.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="icon">S</div>
        <div><strong>${sub.name}</strong><div class="hint">${sub.desc||''}</div></div></div>`;
      const sActions = document.createElement('div'); sActions.className='actions';
      const sOpen = document.createElement('button'); sOpen.className='ghost small'; sOpen.textContent='Open'; sOpen.onclick=(e)=>{ makeRipple(sOpen,e); toggleSub(cat.id, sub.id) };
      const sEdit = document.createElement('button'); sEdit.className='ghost small'; sEdit.textContent='Edit'; sEdit.onclick=(e)=>{ makeRipple(sEdit,e); editSubInline(cat.id, sub.id) };
      const sDel = document.createElement('button'); sDel.className='danger small'; sDel.textContent='Delete'; sDel.onclick=(e)=>{ makeRipple(sDel,e); if(confirm('Delete subcategory?')) deleteSub(cat.id, sub.id) };
      sActions.appendChild(sOpen); sActions.appendChild(sEdit); sActions.appendChild(sDel);
      sNode.appendChild(sActions);
      subsWrap.appendChild(sNode);

      // papers under sub
      const pWrap = document.createElement('div'); pWrap.style.marginLeft='18px'; pWrap.style.marginTop='10px';
      sub.papers.forEach(p=>{
        const pNode = document.createElement('div'); pNode.className='node';
        pNode.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="icon">P</div>
          <div><strong>${p.title}</strong><div class="hint">${p.desc||''}</div></div></div>`;
        const pActions = document.createElement('div'); pActions.className='actions';
        const pOpen = document.createElement('button'); pOpen.className='ghost small'; pOpen.textContent='Open'; pOpen.onclick=(e)=>{ makeRipple(pOpen,e); togglePaper(cat.id,sub.id,p.id) };
        const pEdit = document.createElement('button'); pEdit.className='ghost small'; pEdit.textContent='Edit'; pEdit.onclick=(e)=>{ makeRipple(pEdit,e); editPaperInline(cat.id,sub.id,p.id) };
        const pDel = document.createElement('button'); pDel.className='danger small'; pDel.textContent='Delete'; pDel.onclick=(e)=>{ makeRipple(pDel,e); if(confirm('Delete paper?')) deletePaper(cat.id,sub.id,p.id) };
        pActions.appendChild(pOpen); pActions.appendChild(pEdit); pActions.appendChild(pDel);
        pNode.appendChild(pActions);
        pWrap.appendChild(pNode);

        // years under paper
        const yWrap = document.createElement('div'); yWrap.style.marginLeft='18px'; yWrap.style.marginTop='8px';
        p.years.forEach(y=>{
          const yNode = document.createElement('div'); yNode.className='node';
          yNode.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="icon">Y</div>
            <div><strong>${y.label}</strong><div class="hint">${y.drive||''}</div></div></div>`;
          const yAct = document.createElement('div'); yAct.className='actions';
          const yOpen = document.createElement('button'); yOpen.className='ghost small'; yOpen.textContent='Open'; yOpen.onclick=(e)=>{ makeRipple(yOpen,e); openYearForEdit(cat.id,sub.id,p.id,y.id) };
          const yEdit = document.createElement('button'); yEdit.className='ghost small'; yEdit.textContent='Edit'; yEdit.onclick=(e)=>{ makeRipple(yEdit,e); editYearInline(cat.id,sub.id,p.id,y.id) };
          const yDel = document.createElement('button'); yDel.className='danger small'; yDel.textContent='Delete'; yDel.onclick=(e)=>{ makeRipple(yDel,e); if(confirm('Delete year?')) deleteYear(cat.id,sub.id,p.id,y.id) };
          yAct.appendChild(yOpen); yAct.appendChild(yEdit); yAct.appendChild(yDel);
          yNode.appendChild(yAct);
          yWrap.appendChild(yNode);
        });

        pWrap.appendChild(yWrap);
      });

      subsWrap.appendChild(pWrap);
    });

    panel.appendChild(subsWrap);
    out.appendChild(node);
    out.appendChild(panel);
  });
}

/* ======================
   Toggle / inline edit
   ====================== */
function toggleCategory(catId){
  const c = state.categories.find(x=>x.id===catId);
  c._open = !c._open;
  renderAll();
}
function toggleSub(catId, subId){
  const s = state.categories.find(c=>c.id===catId).subcategories.find(s=>s.id===subId);
  s._open = !s._open;
  renderAll();
}
function togglePaper(catId, subId, paperId){
  const p = state.categories.find(c=>c.id===catId).subcategories.find(s=>s.id===subId).papers.find(p=>p.id===paperId);
  p._open = !p._open;
  renderAll();
}

/* ======================
   Inline edit functions
   ====================== */
function editCategoryInline(catId){
  const c = state.categories.find(x=>x.id===catId);
  const newName = prompt('Edit category name', c.name);
  if(newName!==null){ c.name = newName.trim() || c.name; save(); }
}
function editSubInline(catId, subId){
  const s = state.categories.find(c=>c.id===catId).subcategories.find(s=>s.id===subId);
  const newName = prompt('Edit subcategory name', s.name);
  if(newName!==null){ s.name = newName.trim() || s.name; save(); }
}
function editPaperInline(catId, subId, paperId){
  const p = state.categories.find(c=>c.id===catId).subcategories.find(s=>s.id===subId).papers.find(p=>p.id===paperId);
  const newName = prompt('Edit paper title', p.title);
  if(newName!==null){ p.title = newName.trim() || p.title; save(); }
}
function editYearInline(catId, subId, paperId, yearId){
  const y = state.categories.find(c=>c.id===catId).subcategories.find(s=>s.id===subId).papers.find(p=>p.id===paperId).years.find(y=>y.id===yearId);
  const newLabel = prompt('Edit year/label', y.label);
  if(newLabel!==null){ y.label = newLabel.trim() || y.label; save(); }
}

/* ======================
   Create / Delete
   ====================== */
function addCategory(){
  const name = qs('inpCatName').value.trim();
  const slug = qs('inpCatSlug').value.trim();
  if(!name) return alert('Category name required');
  state.categories.push({ id: uid('cat')rId=Number(document.getElementById("selectPaper").value);
    const yearId=Number(document.getElementById("selectYear").value);
    if(!catId||!subId||!paperId||!yearId) return alert("Select all levels");
    const q={
        id:"q"+Date.now(),
        questionNumber:Number(document.getElementById("qNumber").value),
        questionText:document.getElementById("qText").value.trim(),
        optionA:document.getElementById("optA").value.trim(),
        optionB:document.getElementById("optB").value.trim(),
        optionC:document.getElementById("optC").value.trim(),
        optionD:document.getElementById("optD").value.trim(),
        correctAnswer:document.getElementById("correctOpt").value,
        solution:document.getElementById("qSolution").value.trim(),
        youtubeUrl:document.getElementById("qYoutube").value.trim(),
        driveUrl:document.getElementById("qDrive").value.trim()
    };
    const yearObj=data.categories.find(c=>c.id===catId).subs.find(s=>s.id===subId).papers.find(p=>p.id===paperId).years.find(y=>y.id===yearId);
    if(!yearObj.questions) yearObj.questions=[];
    yearObj.questions.push(q);
    ["qNumber","qText","optA","optB","optC","optD","qSolution","qYoutube","qDrive"].forEach(id=>document.getElementById(id).value="");
    alert("Question added");
    render();
}

// ===== COPY JSON =====
function copyJSON(){
    const box=document.getElementById("jsonBox");
    box.select();
    document.execCommand("copy");
    alert("Copied");
}

render();
</script></body>
                             </html>ection>

    <!-- YEARS (hidden until a paper is opened) -->
    <section id="panel-years" class="card fade" style="display:none">
      <h3>Year / Date for <span id="activePaperName" style="color:var(--accent-2)"></span></h3>
      <p style="color:var(--muted)">Create an entry that links a paper to a year/date. Attach a Google Drive share link for PDF if needed.</p>

      <div class="row" style="margin-top:12px">
        <div style="min-width:220px">
          <label style="color:var(--muted); font-size:12px">Pick month (calendar)</label>
          <input id="entryMonth" type="month" />
        </div>
        <div style="min-width:160px">
          <label style="color:var(--muted); font-size:12px">Or year</label>
          <input id="entryYear" type="number" placeholder="2025" />
        </div>
        <div style="flex:1">
          <label style="color:var(--muted); font-size:12px">Google Drive share link (optional)</label>
          <input id="entryDrive" placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing" />
        </div>
        <div style="min-width:120px; align-self:end">
          <button class="btn" onclick="saveYearEntry()">Create</button>
        </div>
      </div>

      <div id="yearList" class="list"></div>
    </section>

    <!-- QUESTIONS (hidden until a year entry is opened) -->
    <section id="panel-questions" class="card fade" style="display:none">
      <h3>Questions for <span id="activePaperYearName" style="color:var(--accent-2)"></span></h3>
      <p style="color:var(--muted)">Add normal questions or passage-type. Attach PDF via Google Drive to show during practice.</p>

      <div style="margin-top:12px" id="pdfPreviewWrap" class="hidden">
        <div style="margin-bottom:8px; color:var(--muted)">Preview PDF for this paper-year</div>
        <iframe id="pdfPreview" class="preview-frame"></iframe>
      </div>

      <hr />

      <div style="margin-top:12px" class="card">
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <input id="qNumber" type="number" placeholder="Q no" style="width:110px" />
          <input id="qText" placeholder="Question text" style="flex:1" />
        </div>

        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <input id="qA" placeholder="Option A" />
          <input id="qB" placeholder="Option B" />
          <input id="qC" placeholder="Option C" />
          <input id="qD" placeholder="Option D" />
        </div>

        <div style="margin-top:8px; display:flex; gap:12px; align-items:center">
          <input id="qAnswer" placeholder="Correct answer (A/B/C/D)" style="width:180px" />
          <input id="qYoutube" placeholder="YouTube link (optional)" style="flex:1" />
          <button class="btn" onclick="saveQuestion()">Save</button>
          <button class="btn ghost" onclick="clearQuestionForm()">Clear</button>
        </div>

        <div style="margin-top:8px">
          <label style="color:var(--muted)">Passage (optional)</label>
          <textarea id="qPassage" placeholder="If passage-based, paste passage here (it will show above questions)"></textarea>
        </div>

        <div style="margin-top:8px">
          <label style="color:var(--muted)">Solution / Explanation</label>
          <textarea id="qSolution" placeholder="Write solution or explanation"></textarea>
        </div>
      </div>

      <div id="questionList" class="list" style="margin-top:12px"></div>
    </section>

  </main>
</div>

<script>
/* ==========================
   Data model and persistence
   ========================== */
const ADMIN_USER = 'Wan@admin';
const ADMIN_PASS = 'W@npynd@p2002';
const STORAGE_KEY = 'megp_state'; // full state
// also write simplified keys for homepage
const HOME_CATEGORIES_KEY = 'megp_categories';
const HOME_PAPERS_KEY = 'megp_papers';

let state = loadState();

/* structure:
state = {
  categories: [{id,name,slug}],
  papersByCategory: { catId: [ {id,title,duration,marks, years:[{id, label, month, year, driveLink, questions:[...] }]} ] }
}
*/
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { categories:[], papersByCategory:{} };
    return JSON.parse(raw);
  }catch(e){ return { categories:[], papersByCategory:{} } }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // also save simplified keys for homepage
  try{
    const cats = state.categories.map(c => ({id:c.id, name:c.name, slug:c.slug}));
    localStorage.setItem(HOME_CATEGORIES_KEY, JSON.stringify(cats));
    // papers simplified: { catId: [ {id,title,years:[label,...]} ] }
    const p = {};
    Object.entries(state.papersByCategory).forEach(([catId, papers])=>{
      p[catId] = papers.map(pp => ({ id: pp.id, title: pp.title, years: (pp.years||[]).map(y=>y.label) }));
    });
    localStorage.setItem(HOME_PAPERS_KEY, JSON.stringify(p));
  }catch(e){}
}

/* helpers */
function uid(pref='id'){ return pref + '_' + Date.now() + '_' + Math.floor(Math.random()*999) }
function qs(id){ return document.getElementById(id) }
function show(el){ if(!el) return; el.style.display = ''; }
function hide(el){ if(!el) return; el.style.display = 'none' }
function clearInputs(...ids){ ids.forEach(id => qs(id).value = '') }

/* =========================
   AUTH
   ========================= */
function isAuthed(){ return sessionStorage.getItem('megp_admin') === '1' }
function doLogin(){
  const u = qs('loginUser').value.trim();
  const p = qs('loginPass').value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    sessionStorage.setItem('megp_admin','1');
    qs('loginError').style.display='none';
    initAfterLogin();
  } else {
    qs('loginError').style.display='block';
  }
}
function clearLogin(){ qs('loginUser').value=''; qs('loginPass').value=''; qs('loginError').style.display='none'; }
function logout(){ sessionStorage.removeItem('megp_admin'); location.reload(); }

/* =========================
   UI: menu
   ========================= */
document.addEventListener('click', (e)=>{
  const menu = qs('menuPop');
  const btn = qs('menuBtn');
  if(!menu || !btn) return;
  if(e.target === btn || btn.contains(e.target)){
    // handled elsewhere
  } else if(menu.contains(e.target)){
    // inside menu
  } else {
    menu.style.display = 'none';
  }
});
function toggleMenu(){
  const menu = qs('menuPop');
  if(menu.style.display === 'block') menu.style.display = 'none'; else menu.style.display = 'block';
}
function goHome(){ window.location.href = 'homepage.html' }

/* =========================
   Initial boot
   ========================= */
function initAfterLogin(){
  // hide login panel
  qs('loginPanel').style.display = 'none';
  // show categories panel only
  openPanel('categories');
  renderCategories();
  updateNavVisibility();
}
function boot(){
  if(!isAuthed()){
    // show login panel only
    qs('loginPanel').style.display = '';
    // hide other panels
    ['panel-categories','panel-papers','panel-years','panel-questions'].forEach(id => qs(id).style.display = 'none');
    // hide nav others
    ['nav-papers','nav-years','nav-questions'].forEach(id => qs(id).style.display = 'none');
    return;
  }
  // authed
  qs('loginPanel').style.display = 'none';
  renderCategories();
  updateNavVisibility();
  // show categories
  openPanel('categories');
}
boot();

/* =========================
   NAV / PANELS
   ========================= */
function openPanel(key){
  // hide menu
  qs('menuPop').style.display = 'none';

  // panels mapping
  const panels = {
    'categories':'panel-categories',
    'papers':'panel-papers',
    'years':'panel-years',
    'questions':'panel-questions'
  };
  Object.values(panels).forEach(id => hide(qs(id)));
  const panelId = panels[key];
  show(qs(panelId));
  // mark active nav button
  ['nav-categories','nav-papers','nav-years','nav-questions'].forEach(id => qs(id).classList.remove('active'));
  const navId = 'nav-'+ (key==='categories' ? 'categories' : key);
  if(qs(navId)) qs(navId).classList.add('active');
}

/* =========================
   Category: create / list / open
   ========================= */
function saveCategory(){
  const name = qs('catName').value.trim();
  const slug = qs('catSlug').value.trim();
  if(!name){ alert('Enter category name'); return; }
  const id = uid('cat');
  state.categories.push({ id, name, slug: slug || id });
  state.papersByCategory = state.papersByCategory || {};
  state.papersByCategory[id] = state.papersByCategory[id] || [];
  saveState();
  renderCategories();
  clearCategoryForm();
  // open created category automatically
  openCategory(id);
}
function renderCategories(){
  const list = qs('catList'); list.innerHTML = '';
  if(!state.categories.length){ list.innerHTML = '<div style="color:var(--muted)">No categories yet</div>'; return; }
  state.categories.forEach(cat=>{
    const div = document.createElement('div'); div.className='item fade';
    div.innerHTML = `<div class="meta"><h4>${escape(cat.name)}</h4><p>${escape(cat.slug)}</p></div>
      <div class="actions">
        <button class="btn small" onclick="openCategory('${cat.id}')">Open</button>
        <button class="btn ghost small" onclick="editCategory('${cat.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteCategory('${cat.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearCategoryForm(){ qs('catName').value=''; qs('catSlug').value=''; }
function editCategory(id){
  const cat = state.categories.find(c=>c.id===id); if(!cat) return;
  qs('catName').value = cat.name; qs('catSlug').value = cat.slug;
  // optional: replace save to update mode - for simplicity we do manual delete+create if needed
}
function deleteCategory(id){
  if(!confirm('Delete category? Papers under it will be removed.')) return;
  state.categories = state.categories.filter(c=>c.id!==id);
  delete state.papersByCategory[id];
  saveState();
  renderCategories();
  updateNavVisibility();
}

/* =========================
   Open category -> show papers
   ========================= */
let activeCategoryId = null;
function openCategory(catId){
  activeCategoryId = catId;
  const cat = state.categories.find(c=>c.id===catId);
  qs('activeCategoryName').textContent = cat ? cat.name : '';
  // show papers panel and nav button
  qs('nav-papers').style.display = '';
  renderPapersForActiveCategory();
  openPanel('papers');
}

/* =========================
   Papers create / list / open
   ========================= */
function savePaper(){
  if(!activeCategoryId){ alert('Open a category first'); return; }
  const title = qs('paperTitle').value.trim();
  const marks = parseInt(qs('paperMarks').value) || 0;
  const duration = parseInt(qs('paperDuration').value) || 0;
  if(!title){ alert('Enter paper title'); return; }
  const id = uid('paper');
  state.papersByCategory[activeCategoryId] = state.papersByCategory[activeCategoryId] || [];
  state.papersByCategory[activeCategoryId].push({ id, title, marks, duration, years: [] });
  saveState();
  renderPapersForActiveCategory();
  clearPaperForm();
  // open paper automatically
  openPaper(id);
}
function renderPapersForActiveCategory(){
  const list = qs('paperList'); list.innerHTML = '';
  const arr = (state.papersByCategory[activeCategoryId]||[]);
  if(!arr.length){ list.innerHTML = '<div style="color:var(--muted)">No papers yet for this category</div>'; return; }
  arr.forEach(p=>{
    const div = document.createElement('div'); div.className='item fade';
    const yearsCount = (p.years||[]).length;
    div.innerHTML = `<div class="meta"><h4>${escape(p.title)}</h4><p>${yearsCount} year entries · ${p.duration} min · ${p.marks} marks</p></div>
      <div class="actions">
        <button class="btn small" onclick="openPaper('${p.id}')">Open</button>
        <button class="btn ghost small" onclick="editPaper('${activeCategoryId}','${p.id}')">Edit</button>
        <button class="btn danger small" onclick="deletePaper('${activeCategoryId}','${p.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearPaperForm(){ qs('paperTitle').value=''; qs('paperMarks').value=''; qs('paperDuration').value=''; }
function editPaper(catId,paperId){
  const p = (state.papersByCategory[catId]||[]).find(x=>x.id===paperId); if(!p) return;
  qs('paperTitle').value = p.title; qs('paperMarks').value = p.marks; qs('paperDuration').value = p.duration;
  // we'll not implement complex update - user can delete and re-add for now
}
function deletePaper(catId,paperId){
  if(!confirm('Delete paper and all its years and questions?')) return;
  state.papersByCategory[catId] = (state.papersByCategory[catId]||[]).filter(x=>x.id!==paperId);
  saveState();
  renderPapersForActiveCategory();
  updateNavVisibility();
}

/* =========================
   Open paper -> show years
   ========================= */
let activePaperId = null;
function openPaper(paperId){
  activePaperId = paperId;
  const p = (state.papersByCategory[activeCategoryId]||[]).find(x=>x.id===paperId);
  qs('activePaperName').textContent = p ? p.title : '';
  // show years nav/button
  qs('nav-years').style.display = '';
  renderYearList();
  openPanel('years');
}

/* =========================
   Years create / list / open
   ========================= */
function saveYearEntry(){
  if(!activeCategoryId || !activePaperId){ alert('Open a paper first'); return; }
  const monthVal = qs('entryMonth').value; // format "YYYY-MM"
  const yearVal = qs('entryYear').value.trim(); // number string
  const driveLink = qs('entryDrive').value.trim();
  let label = '';
  let month = null;
  let year = null;
  if(monthVal){
    // extract YYYY-MM -> label
    label = monthVal;
    const parts = monthVal.split('-'); year = parseInt(parts[0]); month = parseInt(parts[1]);
  } else if(yearVal){
    label = String(yearVal);
    year = parseInt(yearVal);
  } else {
    alert('Pick a month or enter a year'); return;
  }
  // normalize drive link to preview url if possible
  const previewUrl = buildDrivePreview(driveLink);
  // create
  const yearsArr = getActivePaper().years || [];
  const id = uid('yr');
  yearsArr.push({ id, label, month, year, driveLink: previewUrl, questions: [] });
  getActivePaper().years = yearsArr;
  saveState();
  renderYearList();
  // open newly created
  openYear(id);
  // clear
  qs('entryMonth').value=''; qs('entryYear').value=''; qs('entryDrive').value='';
}
function renderYearList(){
  const list = qs('yearList'); list.innerHTML = '';
  const yearsArr = getActivePaper().years || [];
  if(!yearsArr.length){ list.innerHTML = '<div style="color:var(--muted)">No year entries yet</div>'; return; }
  yearsArr.forEach(y=>{
    const div = document.createElement('div'); div.className='item fade';
    div.innerHTML = `<div class="meta"><h4>${escape(y.label)}</h4><p>${y.driveLink ? 'Has PDF link' : 'No PDF'}</p></div>
      <div class="actions">
        <button class="btn small" onclick="openYear('${y.id}')">Open</button>
        <button class="btn ghost small" onclick="editYear('${y.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteYear('${y.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function getActivePaper(){ return (state.papersByCategory[activeCategoryId]||[]).find(x=>x.id===activePaperId) || { years:[] } }
function editYear(yearId){
  const y = (getActivePaper().years||[]).find(x=>x.id===yearId); if(!y) return;
  if(y.month){
    qs('entryMonth').value = (y.month<10? y.year+'-0'+y.month : y.year+'-'+y.month);
  } else if(y.year){
    qs('entryYear').value = y.year;
  }
  qs('entryDrive').value = y.driveLink || '';
}
function deleteYear(yearId){
  if(!confirm('Delete this year entry and its questions?')) return;
  const arr = getActivePaper().years || [];
  getActivePaper().years = arr.filter(x=>x.id!==yearId);
  saveState();
  renderYearList();
}
let activeYearId = null;
function openYear(yearId){
  activeYearId = yearId;
  // show nav for questions
  qs('nav-questions').style.display = '';
  // show panel questions and set label
  const y = (getActivePaper().years||[]).find(x=>x.id===yearId);
  qs('activePaperYearName').textContent = (y ? `${getActivePaper().title} • ${y.label}` : '');
  // show pdf if present
  if(y && y.driveLink){
    qs('pdfPreview').src = y.driveLink;
    qs('pdfPreviewWrap').classList.remove('hidden');
  } else {
    qs('pdfPreviewWrap').classList.add('hidden');
    qs('pdfPreview').src = '';
  }
  renderQuestionList();
  openPanel('questions');
}

/* =========================
   Questions create / list / edit / delete
   ========================= */
function saveQuestion(){
  if(!activeCategoryId || !activePaperId || !activeYearId){ alert('Open a paper-year first'); return; }
  const number = parseInt(qs('qNumber').value) || 1;
  const text = qs('qText').value.trim();
  if(!text){ alert('Enter question text'); return; }
  const obj = {
    id: uid('q'),
    number,
    text,
    options: { A: qs('qA').value, B: qs('qB').value, C: qs('qC').value, D: qs('qD').value },
    answer: qs('qAnswer').value.trim(),
    youtube: qs('qYoutube').value.trim(),
    passage: qs('qPassage').value.trim(),
    solution: qs('qSolution').value.trim()
  };
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  yearObj.questions = yearObj.questions || [];
  yearObj.questions.push(obj);
  saveState();
  clearQuestionForm();
  renderQuestionList();
}
function renderQuestionList(){
  const list = qs('questionList'); list.innerHTML = '';
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const arr = (yearObj && yearObj.questions) ? yearObj.questions : [];
  if(!arr.length){ list.innerHTML = '<div style="color:var(--muted)">No questions yet</div>'; return; }
  arr.forEach(q=>{
    const div = document.createElement('div'); div.className='item fade';
    const passageHtml = q.passage ? `<div style="margin-top:6px;color:var(--muted)">Passage: ${escape(q.passage.substring(0,120))}…</div>` : '';
    div.innerHTML = `<div class="meta">
        <h4>Q${q.number}: ${escape(q.text.substring(0,140))}</h4>
        <p style="color:var(--muted)">A:${escape(q.options.A)} | B:${escape(q.options.B)} | C:${escape(q.options.C)} | D:${escape(q.options.D)}</p>
        <p style="color:var(--muted)">Answer: ${escape(q.answer)} ${q.youtube ? ' · YouTube' : ''}</p>
        ${passageHtml}
        <p style="color:var(--muted)">Solution: ${escape(q.solution.substring(0,140))}</p>
      </div>
      <div class="actions">
        <button class="btn small" onclick="editQuestion('${q.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteQuestion('${q.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearQuestionForm(){
  qs('qNumber').value = nextQuestionNumber();
  qs('qText').value = ''; qs('qA').value=''; qs('qB').value=''; qs('qC').value=''; qs('qD').value='';
  qs('qAnswer').value=''; qs('qYoutube').value=''; qs('qPassage').value=''; qs('qSolution').value='';
}
function nextQuestionNumber(){
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const arr = (yearObj && yearObj.questions) ? yearObj.questions : [];
  return arr.length ? (Math.max(...arr.map(q=>q.number))+1) : 1;
}
function editQuestion(qid){
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const q = (yearObj.questions||[]).find(x=>x.id===qid); if(!q) return;
  qs('qNumber').value = q.number;
  qs('qText').value = q.text;
  qs('qA').value = q.options.A; qs('qB').value = q.options.B; qs('qC').value = q.options.C; qs('qD').value = q.options.D;
  qs('qAnswer').value = q.answer; qs('qYoutube').value = q.youtube; qs('qPassage').value = q.passage; qs('qSolution').value = q.solution;
  // remove existing q then save will re-add as new; for simplicity editing replaces original
  yearObj.questions = yearObj.questions.filter(x=>x.id!==qid);
  saveState();
  renderQuestionList();
}
function deleteQuestion(qid){
  if(!confirm('Delete this question?')) return;
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  yearObj.questions = (yearObj.questions||[]).filter(x=>x.id!==qid);
  saveState();
  renderQuestionList();
}

/* =========================
   Drive link helper
   ========================= */
function buildDrivePreview(link){
  if(!link) return '';
  // Accept raw file id or full share link
  // If link contains "/file/d/FILE_ID" extract
  const m = link.match(/\/d\/([A-Za-z0-9_-]{10,})/);
  if(m && m[1]) return `https://drive.google.com/file/d/${m[1]}/preview`;
  // if link contains id= param
  const m2 = link.match(/[?&]id=([A-Za-z0-9_-]{10,})/);
  if(m2 && m2[1]) return `https://drive.google.com/file/d/${m2[1]}/preview`;
  // if already a preview URL or direct file id
  if(link.startsWith('https://drive.google.com/file/d/')) return link.replace('/view','/preview');
  if(link.length > 20 && /^[A-Za-z0-9_-]+$/.test(link)) return `https://drive.google.com/file/d/${link}/preview`;
  // fallback: return original link
  return link;
}

/* =========================
   UI helpers
   ========================= */
function updateNavVisibility(){
  // show/hide nav buttons depending on data
  qs('nav-papers').style.display = activeCategoryId ? '' : 'none';
  qs('nav-years').style.display = activePaperId ? '' : 'none';
  qs('nav-questions').style.display = activeYearId ? '' : 'none';
}
function escape(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* =========================
   Utility: open paper/year if persisted or just render
   ========================= */
function updateAfterChanges(){
  saveState();
  renderCategories();
  if(activeCategoryId) renderPapersForActiveCategory();
  if(activePaperId) renderYearList();
  if(activeYearId) renderQuestionList();
  updateNavVisibility();
}

/* =========================
   Save on exit
   ========================= */
window.addEventListener('beforeunload', ()=>{ saveState(); });

/* Final small init */
(function(){
  // make sure the state object has required keys
  state.categories = state.categories || [];
  state.papersByCategory = state.papersByCategory || {};
  // set next qnumber defaults
  if(isAuthed()){
    initAfterLogin();
  }
})();
</script>
</body>
</html>
