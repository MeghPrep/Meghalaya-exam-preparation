<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Manage Categories & Quiz</title>
<style>
body{background:#0A0A0A;color:white;font-family:Arial;padding:16px;}
.container{max-width:900px;margin:auto;}
.card{background:#1E1E1E;padding:16px;margin-bottom:14px;border-radius:8px;}
.card h3{margin-top:0;}
input,textarea,select{width:100%;padding:10px;background:#111;color:white;border:1px solid #333;border-radius:6px;margin-bottom:10px;}
button{padding:10px 16px;background:#1976D2;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px;margin-top:6px;}
button:hover{background:#1565c0;}
.small-btn{background:#D32F2F;}
.small-btn:hover{background:#b71c1c;}
.section{margin-bottom:20px;}
.json-output{width:100%;height:300px;background:#000;color:#0f0;font-family:monospace;padding:10px;border-radius:6px;}
.accordion{background:#1E1E1E;padding:14px;width:100%;border-radius:8px;margin-bottom:8px;cursor:pointer;border:none;text-align:left;font-size:16px;}
.accordion:hover{background:#222;}
.panel{background:#111;padding:12px;margin-bottom:12px;border-radius:8px;display:none;}
.subcard{background:#222;padding:12px;margin:8px 0;border-radius:6px;}
@media(max-width:600px){button{width:100%;margin-right:0;margin-bottom:6px;}}
</style>
</head>
<body><div class="container"><h2>Admin Panel</h2><!-- CATEGORY --><div class="card">
<h3>Add Category</h3>
<input id="catName" placeholder="Category Name">
<textarea id="catDesc" placeholder="Description"></textarea>
<button onclick="addCategory()">Add</button>
</div><!-- SUBCATEGORY --><div class="card">
<h3>Add Subcategory</h3>
<select id="parentCategory"></select>
<input id="subName" placeholder="Subcategory Name">
<textarea id="subDesc" placeholder="Description"></textarea>
<button onclick="addSub()">Add</button>
</div><!-- PAPER --><div class="card">
<h3>Add Paper</h3>
<select id="parentSub"></select>
<input id="paperName" placeholder="Paper Name">
<textarea id="paperDesc" placeholder="Description"></textarea>
<button onclick="addPaper()">Add</button>
</div><!-- YEAR --><div class="card">
<h3>Add Year</h3>
<select id="parentPaper"></select>
<input id="yearText" placeholder="Year Example 2019">
<textarea id="yearDesc" placeholder="Description"></textarea>
<button onclick="addYear()">Add</button>
</div><!-- QUIZ MANAGEMENT --><div class="card">
<h3>Manage Quiz Questions</h3>
<select id="selectCat" onchange="populateSub()"></select>
<select id="selectSub" onchange="populatePaper()"></select>
<select id="selectPaper" onchange="populateYear()"></select>
<select id="selectYear"></select><input id="qNumber" placeholder="Question Number">
<textarea id="qText" placeholder="Question Text"></textarea>
<input id="optA" placeholder="Option A">
<input id="optB" placeholder="Option B">
<input id="optC" placeholder="Option C">
<input id="optD" placeholder="Option D">
<select id="correctOpt">
<option value="">Select Correct Option</option>
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
<option value="D">D</option>
</select>
<textarea id="qSolution" placeholder="Solution"></textarea>
<input id="qYoutube" placeholder="YouTube URL">
<input id="qDrive" placeholder="Drive URL">
<button onclick="addQuestion()">Add Question</button>
</div><h3>Categories</h3>
<div id="categoryList"></div><h3>JSON Output</h3>
<textarea id="jsonBox" class="json-output" readonly></textarea>
<button onclick="copyJSON()">Copy JSON</button></div><script>
let data = {categories:[]};

// ===== RENDER FUNCTION =====
function render(){
    let catList=document.getElementById("categoryList");
    let catSel=document.getElementById("parentCategory");
    let subSel=document.getElementById("parentSub");
    let paperSel=document.getElementById("parentPaper");

    catList.innerHTML="";
    catSel.innerHTML="<option value=''>Select</option>";
    subSel.innerHTML="<option value=''>Select</option>";
    paperSel.innerHTML="<option value=''>Select</option>";

    data.categories.forEach(cat=>{
        catSel.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        let btn=document.createElement("button");
        btn.className="accordion";
        btn.textContent=cat.name;
        let panel=document.createElement("div");
        panel.className="panel";
        let subHTML="";
        cat.subs.forEach(sub=>{
            subSel.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
            let paperHTML="";
            sub.papers.forEach(p=>{
                paperSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                let yearHTML="";
                p.years.forEach(y=>{
                    yearHTML += `<div class='subcard'><strong>${y.year}</strong> ${y.desc} <button class="small-btn" onclick="delYear(${cat.id},${sub.id},${p.id},${y.id})">Delete</button></div>`;
                });
                paperHTML += `<div class='subcard'><strong>${p.name}</strong> ${p.desc} <button class="small-btn" onclick="delPaper(${cat.id},${sub.id},${p.id})">Delete</button><h5>Years</h5>${yearHTML||"No years"}</div>`;
            });
            subHTML += `<div class='subcard'><strong>${sub.name}</strong> ${sub.desc} <button class="small-btn" onclick="delSub(${cat.id},${sub.id})">Delete</button>${paperHTML}</div>`;
        });
        panel.innerHTML=subHTML||"<p>No subcategories</p>";
        btn.onclick=()=>panel.style.display=panel.style.display==="block"?"none":"block";
        catList.appendChild(btn);
        catList.appendChild(panel);
    });
    renderQuizDropdowns();
    document.getElementById("jsonBox").value = JSON.stringify(data,null,4);
}

// ===== ADD FUNCTIONS =====
function addCategory(){
    let name=catName.value.trim();
    if(!name)return alert("Enter name");
    data.categories.push({id:Date.now(),name,desc:catDesc.value.trim(),subs:[]});
    catName.value="";catDesc.value="";
    render();
}

function addSub(){
    let pid=Number(parentCategory.value);
    if(!pid)return alert("Select category");
    let cat=data.categories.find(c=>c.id===pid);
    cat.subs.push({id:Date.now(),name:subName.value.trim(),desc:subDesc.value.trim(),papers:[]});
    subName.value="";subDesc.value="";
    render();
}

function addPaper(){
    let sid=Number(parentSub.value);
    if(!sid)return alert("Select subcategory");
    for(let c of data.categories){
        let s=c.subs.find(x=>x.id===sid);
        if(s)s.papers.push({id:Date.now(),name:paperName.value.trim(),desc:paperDesc.value.trim(),years:[]});
    }
    paperName.value="";paperDesc.value="";
    render();
}

function addYear(){
    let pid=Number(parentPaper.value);
    if(!pid)return alert("Select paper");
    for(let c of data.categories){
        for(let s of c.subs){
            let p=s.papers.find(x=>x.id===pid);
            if(p)p.years.push({id:Date.now(),year:yearText.value.trim(),desc:yearDesc.value.trim()});
        }
    }
    yearText.value="";yearDesc.value="";
    render();
}

// ===== DELETE FUNCTIONS =====
function delSub(cid,sid){let c=data.categories.find(x=>x.id===cid);c.subs=c.subs.filter(x=>x.id!==sid);render();}
function delPaper(cid,sid,pid){let c=data.categories.find(x=>x.id===cid);let s=c.subs.find(x=>x.id===sid);s.papers=s.papers.filter(x=>x.id!==pid);render();}
function delYear(cid,sid,pid,yid){let c=data.categories.find(x=>x.id===cid);let s=c.subs.find(x=>x.id===sid);let p=s.papers.find(x=>x.id===pid);p.years=p.years.filter(x=>x.id!==yid);render();}

// ===== QUIZ MANAGEMENT =====
function renderQuizDropdowns(){
    const selectCat=document.getElementById("selectCat");
    const selectSub=document.getElementById("selectSub");
    const selectPaper=document.getElementById("selectPaper");
    const selectYear=document.getElementById("selectYear");
    if(!selectCat) return;
    selectCat.innerHTML="<option value=''>Select Category</option>";
    selectSub.innerHTML="<option value=''>Select Subcategory</option>";
    selectPaper.innerHTML="<option value=''>Select Paper</option>";
    selectYear.innerHTML="<option value=''>Select Year</option>";
    data.categories.forEach(c=>selectCat.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
}

function populateSub(){
    const catId=Number(document.getElementById("selectCat").value);
    const subSel=document.getElementById("selectSub");
    subSel.innerHTML="<option value=''>Select Subcategory</option>";
    if(!catId)return;
    const cat=data.categories.find(c=>c.id===catId);
    if(cat)cat.subs.forEach(s=>subSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`);
    populatePaper();
}

function populatePaper(){
    const catId=Number(document.getElementById("selectCat").value);
    const subId=Number(document.getElementById("selectSub").value);
    const paperSel=document.getElementById("selectPaper");
    paperSel.innerHTML="<option value=''>Select Paper</option>";
    if(!catId||!subId)return;
    const sub=data.categories.find(c=>c.id===catId).subs.find(s=>s.id===subId);
    if(sub)sub.papers.forEach(p=>paperSel.innerHTML+=`<option value="${p.id}">${p.name}</option>`);
    populateYear();
}

function populateYear(){
    const catId=Number(document.getElementById("selectCat").value);
    const subId=Number(document.getElementById("selectSub").value);
    const paperId=Number(document.getElementById("selectPaper").value);
    const yearSel=document.getElementById("selectYear");
    yearSel.innerHTML="<option value=''>Select Year</option>";
    if(!catId||!subId||!paperId)return;
    const paper=data.categories.find(c=>c.id===catId).subs.find(s=>s.id===subId).papers.find(p=>p.id===paperId);
    if(paper)paper.years.forEach(y=>{ if(!y.questions)y.questions=[]; yearSel.innerHTML+=`<option value="${y.id}">${y.year}</option>` });
}

function addQuestion(){
    const catId=Number(document.getElementById("selectCat").value);
    const subId=Number(document.getElementById("selectSub").value);
    const paperId=Number(document.getElementById("selectPaper").value);
    const yearId=Number(document.getElementById("selectYear").value);
    if(!catId||!subId||!paperId||!yearId) return alert("Select all levels");
    const q={
        id:"q"+Date.now(),
        questionNumber:Number(document.getElementById("qNumber").value),
        questionText:document.getElementById("qText").value.trim(),
        optionA:document.getElementById("optA").value.trim(),
        optionB:document.getElementById("optB").value.trim(),
        optionC:document.getElementById("optC").value.trim(),
        optionD:document.getElementById("optD").value.trim(),
        correctAnswer:document.getElementById("correctOpt").value,
        solution:document.getElementById("qSolution").value.trim(),
        youtubeUrl:document.getElementById("qYoutube").value.trim(),
        driveUrl:document.getElementById("qDrive").value.trim()
    };
    const yearObj=data.categories.find(c=>c.id===catId).subs.find(s=>s.id===subId).papers.find(p=>p.id===paperId).years.find(y=>y.id===yearId);
    if(!yearObj.questions) yearObj.questions=[];
    yearObj.questions.push(q);
    ["qNumber","qText","optA","optB","optC","optD","qSolution","qYoutube","qDrive"].forEach(id=>document.getElementById(id).value="");
    alert("Question added");
    render();
}

// ===== COPY JSON =====
function copyJSON(){
    const box=document.getElementById("jsonBox");
    box.select();
    document.execCommand("copy");
    alert("Copied");
}

render();
</script></body>
                             </html>ection>

    <!-- YEARS (hidden until a paper is opened) -->
    <section id="panel-years" class="card fade" style="display:none">
      <h3>Year / Date for <span id="activePaperName" style="color:var(--accent-2)"></span></h3>
      <p style="color:var(--muted)">Create an entry that links a paper to a year/date. Attach a Google Drive share link for PDF if needed.</p>

      <div class="row" style="margin-top:12px">
        <div style="min-width:220px">
          <label style="color:var(--muted); font-size:12px">Pick month (calendar)</label>
          <input id="entryMonth" type="month" />
        </div>
        <div style="min-width:160px">
          <label style="color:var(--muted); font-size:12px">Or year</label>
          <input id="entryYear" type="number" placeholder="2025" />
        </div>
        <div style="flex:1">
          <label style="color:var(--muted); font-size:12px">Google Drive share link (optional)</label>
          <input id="entryDrive" placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing" />
        </div>
        <div style="min-width:120px; align-self:end">
          <button class="btn" onclick="saveYearEntry()">Create</button>
        </div>
      </div>

      <div id="yearList" class="list"></div>
    </section>

    <!-- QUESTIONS (hidden until a year entry is opened) -->
    <section id="panel-questions" class="card fade" style="display:none">
      <h3>Questions for <span id="activePaperYearName" style="color:var(--accent-2)"></span></h3>
      <p style="color:var(--muted)">Add normal questions or passage-type. Attach PDF via Google Drive to show during practice.</p>

      <div style="margin-top:12px" id="pdfPreviewWrap" class="hidden">
        <div style="margin-bottom:8px; color:var(--muted)">Preview PDF for this paper-year</div>
        <iframe id="pdfPreview" class="preview-frame"></iframe>
      </div>

      <hr />

      <div style="margin-top:12px" class="card">
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <input id="qNumber" type="number" placeholder="Q no" style="width:110px" />
          <input id="qText" placeholder="Question text" style="flex:1" />
        </div>

        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <input id="qA" placeholder="Option A" />
          <input id="qB" placeholder="Option B" />
          <input id="qC" placeholder="Option C" />
          <input id="qD" placeholder="Option D" />
        </div>

        <div style="margin-top:8px; display:flex; gap:12px; align-items:center">
          <input id="qAnswer" placeholder="Correct answer (A/B/C/D)" style="width:180px" />
          <input id="qYoutube" placeholder="YouTube link (optional)" style="flex:1" />
          <button class="btn" onclick="saveQuestion()">Save</button>
          <button class="btn ghost" onclick="clearQuestionForm()">Clear</button>
        </div>

        <div style="margin-top:8px">
          <label style="color:var(--muted)">Passage (optional)</label>
          <textarea id="qPassage" placeholder="If passage-based, paste passage here (it will show above questions)"></textarea>
        </div>

        <div style="margin-top:8px">
          <label style="color:var(--muted)">Solution / Explanation</label>
          <textarea id="qSolution" placeholder="Write solution or explanation"></textarea>
        </div>
      </div>

      <div id="questionList" class="list" style="margin-top:12px"></div>
    </section>

  </main>
</div>

<script>
/* ==========================
   Data model and persistence
   ========================== */
const ADMIN_USER = 'Wan@admin';
const ADMIN_PASS = 'W@npynd@p2002';
const STORAGE_KEY = 'megp_state'; // full state
// also write simplified keys for homepage
const HOME_CATEGORIES_KEY = 'megp_categories';
const HOME_PAPERS_KEY = 'megp_papers';

let state = loadState();

/* structure:
state = {
  categories: [{id,name,slug}],
  papersByCategory: { catId: [ {id,title,duration,marks, years:[{id, label, month, year, driveLink, questions:[...] }]} ] }
}
*/
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { categories:[], papersByCategory:{} };
    return JSON.parse(raw);
  }catch(e){ return { categories:[], papersByCategory:{} } }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  // also save simplified keys for homepage
  try{
    const cats = state.categories.map(c => ({id:c.id, name:c.name, slug:c.slug}));
    localStorage.setItem(HOME_CATEGORIES_KEY, JSON.stringify(cats));
    // papers simplified: { catId: [ {id,title,years:[label,...]} ] }
    const p = {};
    Object.entries(state.papersByCategory).forEach(([catId, papers])=>{
      p[catId] = papers.map(pp => ({ id: pp.id, title: pp.title, years: (pp.years||[]).map(y=>y.label) }));
    });
    localStorage.setItem(HOME_PAPERS_KEY, JSON.stringify(p));
  }catch(e){}
}

/* helpers */
function uid(pref='id'){ return pref + '_' + Date.now() + '_' + Math.floor(Math.random()*999) }
function qs(id){ return document.getElementById(id) }
function show(el){ if(!el) return; el.style.display = ''; }
function hide(el){ if(!el) return; el.style.display = 'none' }
function clearInputs(...ids){ ids.forEach(id => qs(id).value = '') }

/* =========================
   AUTH
   ========================= */
function isAuthed(){ return sessionStorage.getItem('megp_admin') === '1' }
function doLogin(){
  const u = qs('loginUser').value.trim();
  const p = qs('loginPass').value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    sessionStorage.setItem('megp_admin','1');
    qs('loginError').style.display='none';
    initAfterLogin();
  } else {
    qs('loginError').style.display='block';
  }
}
function clearLogin(){ qs('loginUser').value=''; qs('loginPass').value=''; qs('loginError').style.display='none'; }
function logout(){ sessionStorage.removeItem('megp_admin'); location.reload(); }

/* =========================
   UI: menu
   ========================= */
document.addEventListener('click', (e)=>{
  const menu = qs('menuPop');
  const btn = qs('menuBtn');
  if(!menu || !btn) return;
  if(e.target === btn || btn.contains(e.target)){
    // handled elsewhere
  } else if(menu.contains(e.target)){
    // inside menu
  } else {
    menu.style.display = 'none';
  }
});
function toggleMenu(){
  const menu = qs('menuPop');
  if(menu.style.display === 'block') menu.style.display = 'none'; else menu.style.display = 'block';
}
function goHome(){ window.location.href = 'homepage.html' }

/* =========================
   Initial boot
   ========================= */
function initAfterLogin(){
  // hide login panel
  qs('loginPanel').style.display = 'none';
  // show categories panel only
  openPanel('categories');
  renderCategories();
  updateNavVisibility();
}
function boot(){
  if(!isAuthed()){
    // show login panel only
    qs('loginPanel').style.display = '';
    // hide other panels
    ['panel-categories','panel-papers','panel-years','panel-questions'].forEach(id => qs(id).style.display = 'none');
    // hide nav others
    ['nav-papers','nav-years','nav-questions'].forEach(id => qs(id).style.display = 'none');
    return;
  }
  // authed
  qs('loginPanel').style.display = 'none';
  renderCategories();
  updateNavVisibility();
  // show categories
  openPanel('categories');
}
boot();

/* =========================
   NAV / PANELS
   ========================= */
function openPanel(key){
  // hide menu
  qs('menuPop').style.display = 'none';

  // panels mapping
  const panels = {
    'categories':'panel-categories',
    'papers':'panel-papers',
    'years':'panel-years',
    'questions':'panel-questions'
  };
  Object.values(panels).forEach(id => hide(qs(id)));
  const panelId = panels[key];
  show(qs(panelId));
  // mark active nav button
  ['nav-categories','nav-papers','nav-years','nav-questions'].forEach(id => qs(id).classList.remove('active'));
  const navId = 'nav-'+ (key==='categories' ? 'categories' : key);
  if(qs(navId)) qs(navId).classList.add('active');
}

/* =========================
   Category: create / list / open
   ========================= */
function saveCategory(){
  const name = qs('catName').value.trim();
  const slug = qs('catSlug').value.trim();
  if(!name){ alert('Enter category name'); return; }
  const id = uid('cat');
  state.categories.push({ id, name, slug: slug || id });
  state.papersByCategory = state.papersByCategory || {};
  state.papersByCategory[id] = state.papersByCategory[id] || [];
  saveState();
  renderCategories();
  clearCategoryForm();
  // open created category automatically
  openCategory(id);
}
function renderCategories(){
  const list = qs('catList'); list.innerHTML = '';
  if(!state.categories.length){ list.innerHTML = '<div style="color:var(--muted)">No categories yet</div>'; return; }
  state.categories.forEach(cat=>{
    const div = document.createElement('div'); div.className='item fade';
    div.innerHTML = `<div class="meta"><h4>${escape(cat.name)}</h4><p>${escape(cat.slug)}</p></div>
      <div class="actions">
        <button class="btn small" onclick="openCategory('${cat.id}')">Open</button>
        <button class="btn ghost small" onclick="editCategory('${cat.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteCategory('${cat.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearCategoryForm(){ qs('catName').value=''; qs('catSlug').value=''; }
function editCategory(id){
  const cat = state.categories.find(c=>c.id===id); if(!cat) return;
  qs('catName').value = cat.name; qs('catSlug').value = cat.slug;
  // optional: replace save to update mode - for simplicity we do manual delete+create if needed
}
function deleteCategory(id){
  if(!confirm('Delete category? Papers under it will be removed.')) return;
  state.categories = state.categories.filter(c=>c.id!==id);
  delete state.papersByCategory[id];
  saveState();
  renderCategories();
  updateNavVisibility();
}

/* =========================
   Open category -> show papers
   ========================= */
let activeCategoryId = null;
function openCategory(catId){
  activeCategoryId = catId;
  const cat = state.categories.find(c=>c.id===catId);
  qs('activeCategoryName').textContent = cat ? cat.name : '';
  // show papers panel and nav button
  qs('nav-papers').style.display = '';
  renderPapersForActiveCategory();
  openPanel('papers');
}

/* =========================
   Papers create / list / open
   ========================= */
function savePaper(){
  if(!activeCategoryId){ alert('Open a category first'); return; }
  const title = qs('paperTitle').value.trim();
  const marks = parseInt(qs('paperMarks').value) || 0;
  const duration = parseInt(qs('paperDuration').value) || 0;
  if(!title){ alert('Enter paper title'); return; }
  const id = uid('paper');
  state.papersByCategory[activeCategoryId] = state.papersByCategory[activeCategoryId] || [];
  state.papersByCategory[activeCategoryId].push({ id, title, marks, duration, years: [] });
  saveState();
  renderPapersForActiveCategory();
  clearPaperForm();
  // open paper automatically
  openPaper(id);
}
function renderPapersForActiveCategory(){
  const list = qs('paperList'); list.innerHTML = '';
  const arr = (state.papersByCategory[activeCategoryId]||[]);
  if(!arr.length){ list.innerHTML = '<div style="color:var(--muted)">No papers yet for this category</div>'; return; }
  arr.forEach(p=>{
    const div = document.createElement('div'); div.className='item fade';
    const yearsCount = (p.years||[]).length;
    div.innerHTML = `<div class="meta"><h4>${escape(p.title)}</h4><p>${yearsCount} year entries · ${p.duration} min · ${p.marks} marks</p></div>
      <div class="actions">
        <button class="btn small" onclick="openPaper('${p.id}')">Open</button>
        <button class="btn ghost small" onclick="editPaper('${activeCategoryId}','${p.id}')">Edit</button>
        <button class="btn danger small" onclick="deletePaper('${activeCategoryId}','${p.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearPaperForm(){ qs('paperTitle').value=''; qs('paperMarks').value=''; qs('paperDuration').value=''; }
function editPaper(catId,paperId){
  const p = (state.papersByCategory[catId]||[]).find(x=>x.id===paperId); if(!p) return;
  qs('paperTitle').value = p.title; qs('paperMarks').value = p.marks; qs('paperDuration').value = p.duration;
  // we'll not implement complex update - user can delete and re-add for now
}
function deletePaper(catId,paperId){
  if(!confirm('Delete paper and all its years and questions?')) return;
  state.papersByCategory[catId] = (state.papersByCategory[catId]||[]).filter(x=>x.id!==paperId);
  saveState();
  renderPapersForActiveCategory();
  updateNavVisibility();
}

/* =========================
   Open paper -> show years
   ========================= */
let activePaperId = null;
function openPaper(paperId){
  activePaperId = paperId;
  const p = (state.papersByCategory[activeCategoryId]||[]).find(x=>x.id===paperId);
  qs('activePaperName').textContent = p ? p.title : '';
  // show years nav/button
  qs('nav-years').style.display = '';
  renderYearList();
  openPanel('years');
}

/* =========================
   Years create / list / open
   ========================= */
function saveYearEntry(){
  if(!activeCategoryId || !activePaperId){ alert('Open a paper first'); return; }
  const monthVal = qs('entryMonth').value; // format "YYYY-MM"
  const yearVal = qs('entryYear').value.trim(); // number string
  const driveLink = qs('entryDrive').value.trim();
  let label = '';
  let month = null;
  let year = null;
  if(monthVal){
    // extract YYYY-MM -> label
    label = monthVal;
    const parts = monthVal.split('-'); year = parseInt(parts[0]); month = parseInt(parts[1]);
  } else if(yearVal){
    label = String(yearVal);
    year = parseInt(yearVal);
  } else {
    alert('Pick a month or enter a year'); return;
  }
  // normalize drive link to preview url if possible
  const previewUrl = buildDrivePreview(driveLink);
  // create
  const yearsArr = getActivePaper().years || [];
  const id = uid('yr');
  yearsArr.push({ id, label, month, year, driveLink: previewUrl, questions: [] });
  getActivePaper().years = yearsArr;
  saveState();
  renderYearList();
  // open newly created
  openYear(id);
  // clear
  qs('entryMonth').value=''; qs('entryYear').value=''; qs('entryDrive').value='';
}
function renderYearList(){
  const list = qs('yearList'); list.innerHTML = '';
  const yearsArr = getActivePaper().years || [];
  if(!yearsArr.length){ list.innerHTML = '<div style="color:var(--muted)">No year entries yet</div>'; return; }
  yearsArr.forEach(y=>{
    const div = document.createElement('div'); div.className='item fade';
    div.innerHTML = `<div class="meta"><h4>${escape(y.label)}</h4><p>${y.driveLink ? 'Has PDF link' : 'No PDF'}</p></div>
      <div class="actions">
        <button class="btn small" onclick="openYear('${y.id}')">Open</button>
        <button class="btn ghost small" onclick="editYear('${y.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteYear('${y.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function getActivePaper(){ return (state.papersByCategory[activeCategoryId]||[]).find(x=>x.id===activePaperId) || { years:[] } }
function editYear(yearId){
  const y = (getActivePaper().years||[]).find(x=>x.id===yearId); if(!y) return;
  if(y.month){
    qs('entryMonth').value = (y.month<10? y.year+'-0'+y.month : y.year+'-'+y.month);
  } else if(y.year){
    qs('entryYear').value = y.year;
  }
  qs('entryDrive').value = y.driveLink || '';
}
function deleteYear(yearId){
  if(!confirm('Delete this year entry and its questions?')) return;
  const arr = getActivePaper().years || [];
  getActivePaper().years = arr.filter(x=>x.id!==yearId);
  saveState();
  renderYearList();
}
let activeYearId = null;
function openYear(yearId){
  activeYearId = yearId;
  // show nav for questions
  qs('nav-questions').style.display = '';
  // show panel questions and set label
  const y = (getActivePaper().years||[]).find(x=>x.id===yearId);
  qs('activePaperYearName').textContent = (y ? `${getActivePaper().title} • ${y.label}` : '');
  // show pdf if present
  if(y && y.driveLink){
    qs('pdfPreview').src = y.driveLink;
    qs('pdfPreviewWrap').classList.remove('hidden');
  } else {
    qs('pdfPreviewWrap').classList.add('hidden');
    qs('pdfPreview').src = '';
  }
  renderQuestionList();
  openPanel('questions');
}

/* =========================
   Questions create / list / edit / delete
   ========================= */
function saveQuestion(){
  if(!activeCategoryId || !activePaperId || !activeYearId){ alert('Open a paper-year first'); return; }
  const number = parseInt(qs('qNumber').value) || 1;
  const text = qs('qText').value.trim();
  if(!text){ alert('Enter question text'); return; }
  const obj = {
    id: uid('q'),
    number,
    text,
    options: { A: qs('qA').value, B: qs('qB').value, C: qs('qC').value, D: qs('qD').value },
    answer: qs('qAnswer').value.trim(),
    youtube: qs('qYoutube').value.trim(),
    passage: qs('qPassage').value.trim(),
    solution: qs('qSolution').value.trim()
  };
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  yearObj.questions = yearObj.questions || [];
  yearObj.questions.push(obj);
  saveState();
  clearQuestionForm();
  renderQuestionList();
}
function renderQuestionList(){
  const list = qs('questionList'); list.innerHTML = '';
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const arr = (yearObj && yearObj.questions) ? yearObj.questions : [];
  if(!arr.length){ list.innerHTML = '<div style="color:var(--muted)">No questions yet</div>'; return; }
  arr.forEach(q=>{
    const div = document.createElement('div'); div.className='item fade';
    const passageHtml = q.passage ? `<div style="margin-top:6px;color:var(--muted)">Passage: ${escape(q.passage.substring(0,120))}…</div>` : '';
    div.innerHTML = `<div class="meta">
        <h4>Q${q.number}: ${escape(q.text.substring(0,140))}</h4>
        <p style="color:var(--muted)">A:${escape(q.options.A)} | B:${escape(q.options.B)} | C:${escape(q.options.C)} | D:${escape(q.options.D)}</p>
        <p style="color:var(--muted)">Answer: ${escape(q.answer)} ${q.youtube ? ' · YouTube' : ''}</p>
        ${passageHtml}
        <p style="color:var(--muted)">Solution: ${escape(q.solution.substring(0,140))}</p>
      </div>
      <div class="actions">
        <button class="btn small" onclick="editQuestion('${q.id}')">Edit</button>
        <button class="btn danger small" onclick="deleteQuestion('${q.id}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
function clearQuestionForm(){
  qs('qNumber').value = nextQuestionNumber();
  qs('qText').value = ''; qs('qA').value=''; qs('qB').value=''; qs('qC').value=''; qs('qD').value='';
  qs('qAnswer').value=''; qs('qYoutube').value=''; qs('qPassage').value=''; qs('qSolution').value='';
}
function nextQuestionNumber(){
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const arr = (yearObj && yearObj.questions) ? yearObj.questions : [];
  return arr.length ? (Math.max(...arr.map(q=>q.number))+1) : 1;
}
function editQuestion(qid){
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  const q = (yearObj.questions||[]).find(x=>x.id===qid); if(!q) return;
  qs('qNumber').value = q.number;
  qs('qText').value = q.text;
  qs('qA').value = q.options.A; qs('qB').value = q.options.B; qs('qC').value = q.options.C; qs('qD').value = q.options.D;
  qs('qAnswer').value = q.answer; qs('qYoutube').value = q.youtube; qs('qPassage').value = q.passage; qs('qSolution').value = q.solution;
  // remove existing q then save will re-add as new; for simplicity editing replaces original
  yearObj.questions = yearObj.questions.filter(x=>x.id!==qid);
  saveState();
  renderQuestionList();
}
function deleteQuestion(qid){
  if(!confirm('Delete this question?')) return;
  const yearObj = (getActivePaper().years||[]).find(x=>x.id===activeYearId);
  yearObj.questions = (yearObj.questions||[]).filter(x=>x.id!==qid);
  saveState();
  renderQuestionList();
}

/* =========================
   Drive link helper
   ========================= */
function buildDrivePreview(link){
  if(!link) return '';
  // Accept raw file id or full share link
  // If link contains "/file/d/FILE_ID" extract
  const m = link.match(/\/d\/([A-Za-z0-9_-]{10,})/);
  if(m && m[1]) return `https://drive.google.com/file/d/${m[1]}/preview`;
  // if link contains id= param
  const m2 = link.match(/[?&]id=([A-Za-z0-9_-]{10,})/);
  if(m2 && m2[1]) return `https://drive.google.com/file/d/${m2[1]}/preview`;
  // if already a preview URL or direct file id
  if(link.startsWith('https://drive.google.com/file/d/')) return link.replace('/view','/preview');
  if(link.length > 20 && /^[A-Za-z0-9_-]+$/.test(link)) return `https://drive.google.com/file/d/${link}/preview`;
  // fallback: return original link
  return link;
}

/* =========================
   UI helpers
   ========================= */
function updateNavVisibility(){
  // show/hide nav buttons depending on data
  qs('nav-papers').style.display = activeCategoryId ? '' : 'none';
  qs('nav-years').style.display = activePaperId ? '' : 'none';
  qs('nav-questions').style.display = activeYearId ? '' : 'none';
}
function escape(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* =========================
   Utility: open paper/year if persisted or just render
   ========================= */
function updateAfterChanges(){
  saveState();
  renderCategories();
  if(activeCategoryId) renderPapersForActiveCategory();
  if(activePaperId) renderYearList();
  if(activeYearId) renderQuestionList();
  updateNavVisibility();
}

/* =========================
   Save on exit
   ========================= */
window.addEventListener('beforeunload', ()=>{ saveState(); });

/* Final small init */
(function(){
  // make sure the state object has required keys
  state.categories = state.categories || [];
  state.papersByCategory = state.papersByCategory || {};
  // set next qnumber defaults
  if(isAuthed()){
    initAfterLogin();
  }
})();
</script>
</body>
</html>
